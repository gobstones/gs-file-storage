<link rel="import" href="gs-custom-event-target.html">
<dom-module id="gs-file-storage">
  <template>
    <style>
      

      /*# sourceMappingURL=style.css.map */

    </style>


  </template>
  <script>
    var GsFileStorage;

    GsFileStorage = function() {
      var methods, _checkServiceInNameSpace;
      _checkServiceInNameSpace = function() {
        window.GS = window.GS || {};
        return window.GS.GSFILESTORAGE = window.GS.GSFILESTORAGE || (function() {
          methods.initialize();
          return methods;
        })();
      };
      methods = {
        _strfy: function(item) {
          return JSON.stringify(item);
        },
        _parseJs: function(string) {
          return JSON.parse(string);
        },
        removeFile: function(fileName) {
          var getGsFile;
          getGsFile = this.hotFiles[fileName];
          if (getGsFile) {
            getGsFile.remove();
            delete this.hotFiles[fileName];
          }
          this.storage.removeItem('gsFiles.' + fileName);
          if (this.filesNameList.indexOf(fileName) !== -1) {
            return this._fire("listchange");
          }
        },
        _fileNameValid: function(name) {
          return name !== void 0 && name.match(/[a-zA-Z]/) && name[0] !== " ";
        },
        open: function(fileName, host) {
          var file, fileExist;
          if (this._fileNameValid(fileName)) {
            fileExist = this._getFileInMemoryOrLocalStorage(fileName);
            if (fileExist) {
              return fileExist;
              return fileExist.open(this);
            } else {
              file = new GSFILE(fileName);
              this.hotFiles[file.getName()] = file;
              file.open(this);
              this._handleClose(file);
              return file;
            }
          } else {
            throw "Invalid file name.";
          }
        },
        _handleClose: function(file) {
          return file.addEventListener('closefile', (function(_this) {
            return function(event) {
              return console.log(" se llamo al evento");
            };
          })(this));
        },
        storageFile: function(gsFile) {
          var data, filesListChanged;
          filesListChanged = this.filesNameList.indexOf(gsFile.getName()) === -1;
          this.hotFiles[gsFile.getName()] = gsFile;
          data = gsFile.getData();
          this.storage.setItem('gsFiles.' + gsFile.getName(), this._strfy(data));
          if (filesListChanged) {
            return this._fire("listchange");
          }
        },
        _fire: function(eventName) {
          var evnt;
          evnt = document.createEvent('CustomEvent');
          evnt.initEvent(eventName, true, true);
          return this.dispatchEvent(evnt);
        },
        _getFileInMemoryOrLocalStorage: function(fileName) {
          var existLS, file, fileExistJS, parsedFile;
          fileExistJS = this.hotFiles[fileName];
          if (fileExistJS) {
            return fileExistJS;
          }
          existLS = this.storage.getItem('gsFiles.' + fileName);
          if (existLS) {
            parsedFile = this._parseJs(existLS);
            file = new GSFILE(parsedFile.name);
            file.setContent(parsedFile.content);
            this.hotFiles[fileName] = file;
            return file;
          }
        },
        getAllFilesName: function() {
          this.filesNameList = this._allStorage();
          return this.filesNameList;
        },
        _allStorage: function() {
          var key, keys, storagedKey, _i, _len;
          keys = Object.keys(this.storage);
          storagedKey = [];
          for (_i = 0, _len = keys.length; _i < _len; _i++) {
            key = keys[_i];
            if (key.lastIndexOf('gsFiles.', 0) === 0) {
              storagedKey.push(key.replace('gsFiles.', ""));
            }
          }
          return storagedKey;
        },
        _listenOtherTabsFilesChange: function() {
          return window.addEventListener('storage', (function(_this) {
            return function(event) {
              var newFile;
              if (event.newValue === null) {
                return _this.removeFile(_this._parseJs(event.oldValue).name);
              } else {
                console.log("storage event in new value something");
                newFile = _this._parseJs(event.newValue);
                if (_this.filesNameList.indexOf(newFile.name) === -1) {
                  _this.filesNameList.push(newFile.name);
                  return _this._fire("listchange");
                } else {
                  if (_this.hotFiles[newFile.name]) {
                    return _this.hotFiles[newFile.name].update(newFile.content, _this);
                  }
                }
              }
            };
          })(this));
        },
        initialize: function() {
          console.log("initialized");
          CustomEventTarget.apply(this);
          this.storage = window.localStorage;
          this.hotFiles = {};
          this.filesNameList = [];
          return this._listenOtherTabsFilesChange();
        }
      };
      _checkServiceInNameSpace();
      return window.GS.GSFILESTORAGE;
    };

  </script>
</dom-module>