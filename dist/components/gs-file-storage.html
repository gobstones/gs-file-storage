<link rel="import" href="gs-custom-event-target.html">
<dom-module id="gs-file-storage">
  <template>
    <style>
      

      /*# sourceMappingURL=style.css.map */

    </style>


  </template>
  <script>
    var GsFileStorage;

    GsFileStorage = function() {
      var methods, _checkServiceInNameSpace;
      _checkServiceInNameSpace = function() {
        window.GS = window.GS || {};
        return window.GS.GSFILESTORAGE = window.GS.GSFILESTORAGE || (function() {
          methods.initialize();
          return methods;
        })();
      };
      methods = {
        _strfy: function(item) {
          return JSON.stringify(item);
        },
        _parseJs: function(string) {
          return JSON.parse(string);
        },
        removeFile: function(fileName) {
          var exist;
          exist = this.hotFiles[fileName];
          if (exist) {
            delete this.hotFiles[fileName];
            return this.storage.setItem('gsFiles', this._strfy(this.hotFiles));
          } else {
            throw "No sutch file with that name.";
          }
        },
        _fileNameValid: function(name) {
          return name !== void 0 && name.match(/[a-zA-Z]/) && name[0] !== " ";
        },
        getFile: function(fileName) {
          var file, fileExist;
          if (this._fileNameValid(fileName)) {
            fileExist = this._fileExist(fileName);
            if (fileExist) {
              return fileExist;
            } else {
              file = new GSFILE(fileName);
              this.storageFile(file);
              return file;
            }
          } else {
            throw "Invalid file name.";
          }
        },
        storageFile: function(gsFile) {
          var data, filesListChanged;
          filesListChanged = this.filesNameList.indexOf(gsFile.getName()) === -1;
          this.hotFiles[gsFile.getName()] = gsFile;
          data = gsFile.getData();
          this.storage.setItem('gsFiles.' + gsFile.getName(), this._strfy(data));
          if (filesListChanged) {
            return this._fire("listchange");
          }
        },
        _fire: function(eventName) {
          var evnt;
          evnt = document.createEvent('CustomEvent');
          evnt.initEvent(eventName, true, true);
          return this.dispatchEvent(evnt);
        },
        _fileExist: function(fileName) {
          var existLS, file, fileExistJS, parsedFile;
          fileExistJS = this.hotFiles[fileName];
          if (fileExistJS) {
            return fileExistJS;
          }
          existLS = this.storage.getItem('gsFiles.' + fileName);
          if (existLS) {
            parsedFile = this._parseJs(existLS);
            file = new GSFILE(parsedFile.name);
            file.setContent(parsedFile.content);
            this.hotFiles[fileName] = file;
            return file;
          }
        },
        getAllFilesName: function() {
          this.filesNameList = this._allStorage();
          return this.filesNameList;
        },
        _allStorage: function() {
          var key, keys, storagedKey, _i, _len;
          keys = Object.keys(this.storage);
          storagedKey = [];
          for (_i = 0, _len = keys.length; _i < _len; _i++) {
            key = keys[_i];
            if (key.lastIndexOf('gsFiles.', 0) === 0) {
              storagedKey.push(key.replace('gsFiles.', ""));
            }
          }
          return storagedKey;
        },
        initialize: function() {
          console.log("initialized");
          CustomEventTarget.apply(this);
          this.storage = window.localStorage;
          this.hotFiles = {};
          this.filesNameList = [];
          return window.addEventListener('storage', (function(_this) {
            return function(event) {
              var filesListChanged, newFile;
              console.log(event);
              newFile = _this._parseJs(event.newValue);
              filesListChanged = _this.filesNameList.indexOf(newFile.name) === -1;
              if (filesListChanged) {
                console.log("trigered listachange event");
                _this.filesNameList.push(newFile.name);
                return _this._fire("listchange");
              } else {
                if (_this.hotFiles[newFile.name]) {
                  _this.hotFiles[newFile.name].setContent(newFile.content);
                  return _this.hotFiles[newFile.name].fire("change", _this);
                }
              }
            };
          })(this));
        }
      };
      _checkServiceInNameSpace();
      return window.GS.GSFILESTORAGE;
    };

  </script>
</dom-module>